<h1><center>lab1 虚拟环境下的共享式和交换式以太网组网实验报告</center></h1>

 <h3><center>物联网工程___2111194___胡博程 </center></h3>




# 一、实验要求

摘自学院网站

### 仿真环境下的共享式以太网组网

1. 学习虚拟仿真软件的基本使用方法。
2. 在仿真环境下进行单集线器共享式以太网组网，测试网络的连通性。
3. 在仿真环境下进行多集线器共享式以太网组网，测试网络的连通性。
4. 在仿真环境的“模拟”方式中观察数据包在共享式以太网中的传递过程，并进行分析。



### 仿真环境下的交换式以太网组网和VLAN配置

1. 在仿真环境下进行单交换机以太网组网，测试网络的连通性。
2. 在仿真环境下利用终端方式对交换机进行配置。
3. 在单台交换机中划分VLAN，测试同一VLAN中主机的连通性和不同VLAN中主机的连通性，并对现象进行分析。
4. 在仿真环境下组建多集线器、多交换机混合式网络。划分跨越交换机的VLAN，测试同一VLAN中主机的连通性和不同VLAN中主机的连通性，并对现象进行分析。
5. 在仿真环境的“模拟”方式中观察数据包在混合式以太网、虚拟局域网中的传递过程，并进行分析。
6. 学习仿真环境提供的简化配置方式。



# 二、实验准备

1. 安装CISCO PACKET TRACER，注册相关账号
2. 学习软件基本用法，掌握集线器、交换机、直通线、交叉线等使用
3. 建立辅助实验完成的网络拓扑结构



# 三、实验过程

### 1、共享式以太网组网

##### （1）单集线器的简易尝试

首先在仿真软件中连接网络的逻辑结构，**直通线**负责集线器/交换机和主机间的连接，**交叉线**负责集线器之间、交换器之间、交换器集线器之间的连接，**串口线**用于给交换机分配控制主机

网络拓部结构如下：

<img src="E:/Markdown图片/29b33d8fa2f51b60b513360531da6b6.png" alt="29b33d8fa2f51b60b513360531da6b6" width=500 />

点击PC主机，使用下面的方法配置主机IP地址，这里我们将PC0的IP地址指定为192.168.1.1，PC1的IP地址指定为192.168.1.2

<img src="E:/Markdown图片/c8817e092540129bc9b1e6f5ba88731-1696923144958.png" alt="c8817e092540129bc9b1e6f5ba88731" width=500 />

在PC1上使用ping命令进行测试

<img src="E:/Markdown图片/360f8da430815b88e0d3ddec7a8437b-1696932770655.png" alt="360f8da430815b88e0d3ddec7a8437b" width="500"/>



在PC2上使用ping命令测试

<img src="E:/Markdown图片/360f8da430815b88e0d3ddec7a8437b.png" alt="123" width="500" />

由此看出两个主机可以互相ping通

##### （2）多集线器

网络拓扑结构如下

<img src="E:/Markdown图片/e57d34c0c929944c00e6325811bb6d4.png" alt="e57d34c0c929944c00e6325811bb6d4" width=500 />

设置PC2的IP地址为192.168.1.3

<img src="E:/Markdown图片/1960abc607d48dc4619d46982963632.png" alt="1960abc607d48dc4619d46982963632" width=500 />

在PC0处ping PC2

<img src="E:/Markdown图片/b8a69dd509b9cd98bfe50e30f2e6760.png" alt="b8a69dd509b9cd98bfe50e30f2e6760" width=500 />

反之亦然

<img src="E:/Markdown图片/da4b0dae610b11323e34ed06ad4971d.png" alt="da4b0dae610b11323e34ed06ad4971d" width=500 />

##### （3）模拟冲突和非冲突两情况

由于集线器只支持半双工通信，这意味着数据只能在一个方向上流动，而不能同时在两个方向上流动，且集线器的非智能性（它不知道连接到它的哪个端口的设备正在发送数据），所以线路中同时只可以有一个设备可以占用线路发送数据。

我们模拟发送数据包如下**（PC0到PC1；PC2到PC3）**

<img src="E:/Markdown图片/29a553c6380e86b383a3ad7c6334861.png" alt="29a553c6380e86b383a3ad7c6334861" width=500 />

过滤ICMP协议，得到模拟发包的具体流程

<img src="E:/Markdown图片/1ebc117cf45bbb4d3deeb4a84f2e5d0.png" alt="1ebc117cf45bbb4d3deeb4a84f2e5d0" width=500 />

**详细解释冲突的产生**：

<img src="E:/Markdown图片/dbb23b94a3fa0cdcec168673739b126.png" alt="dbb23b94a3fa0cdcec168673739b126" width=500/>

首先两个主机发送数据包到集线器

<img src="E:/Markdown图片/f017ad5075bb75e82f41d56ac71d636.png" alt="f017ad5075bb75e82f41d56ac71d636" width=500 />

集线器广播数据包，导致在红蓝交接的线路上冲突，而PC1接到由hub1转向PC1的数据包，将发回一个回复

<img src="E:/Markdown图片/37d46060d69b788575eb31180ac57b3.png" alt="37d46060d69b788575eb31180ac57b3" width=500/>

回复的过程中绿色的箭头表示回复数据包方向，红蓝为两个主机发出包的方向，据上图仍旧有冲突

**详细解释没有冲突**：PC0给PC2发包，一次ping过程中数据包的流向如下图所示

<img src="E:/Markdown图片/d02cef0c56ef68405b2861a0a4bb1eb.png" alt="d02cef0c56ef68405b2861a0a4bb1eb" width=500 />

<img src="E:/Markdown图片/a37c7cbc920086f9c591eb8c57a9617.png" alt="a37c7cbc920086f9c591eb8c57a9617" width=500 />

如上图所示，集线器是一种非智能设备，将会把其接受的数据包以广播的形式转发给其联通的所有设备

<img src="E:/Markdown图片/f9f87f98914f5e484382602eaccee04.png" alt="f9f87f98914f5e484382602eaccee04" width=500/>

上图展现了数据包到达目标主机PC2，PC3也会收到包但是PC3不接收

<img src="E:/Markdown图片/image-20231011163806947.png" alt="image-20231011163806947" width=500 />

PC2开始回复

<img src="E:/Markdown图片/2d720cd279f66e9c617ee9b3c42df8f.png" alt="2d720cd279f66e9c617ee9b3c42df8f" width=500 />

<img src="E:/Markdown图片/bcb39561cc4b4203bd315469eabe6a7.png" alt="bcb39561cc4b4203bd315469eabe6a7" width=500/>

如上图，回复消息回到PC0并被主机接受

### 2、交换式以太网组网

##### （1）单交换机组网

拓扑结构如下

<img src="E:/Markdown图片/72b5f03e15c2dea8d7bd214f0b61800.png" alt="72b5f03e15c2dea8d7bd214f0b61800" width=500/>

**PC0给PC1发包，发现可以ping通**，详见下图

<img src="E:/Markdown图片/4ae1e3fe3149a65fa9d18dcb445f3d5.png" alt="4ae1e3fe3149a65fa9d18dcb445f3d5" width=500 />

此时查看交换机的mac地址映射表可以找到对应端口下地址映射关系、端口虚拟局域网信息、MAC地址的类型等信息，可以发现我们分配了设备的以太网接口情况，如下图

<img src="E:/Markdown图片/c06cdd8b8452446c7f6c1da354182df.png" alt="c06cdd8b8452446c7f6c1da354182df" width=500 />

##### （2）使用终端配置交换机

具体步骤如下：

1. 使用`enable`命令进入特权用户模式

2. 输入`setup`进入设置

   <img src="E:/Markdown图片/image-20231010184728781.png" alt="image-20231010184728781" width=500 />

3. 配置交换机名称、交换机配置管理密码、进入特权用户模式时的密码

   <img src="E:/Markdown图片/image-20231010184742293.png" alt="image-20231010184742293" width=500 />

4. 不需要配置SNMP（简单网络管理协议）——因为我们不需要远程监控，输出交换机接口概况

   <img src="E:/Markdown图片/image-20231010184751207.png" alt="image-20231010184751207" width=500 />

5. 输入想要配置接口的名称，如`FastEthernet0/1`，紧接着配置这个端口的IP地址和子网掩码

   <img src="E:/Markdown图片/image-20231010184759994.png" alt="image-20231010184759994" width=500 />

6. 最后直接回车保存一切配置信息

   <img src="E:/Markdown图片/image-20231010184809087.png" alt="image-20231010184809087" width=500 />

##### （3）单交换机划分VLAN并尝试PING

网络拓扑结构如图所示

<img src="E:/Markdown图片/image-20231010190346419.png" alt="image-20231010190346419" width=500 />

具体步骤如下

1. 进入交换机的CLI界面，输入`enable`命令进入特权模式。
2. 输入`configure terminal`命令进入全局配置模式。
3. 使用`vlan`命令创建虚拟局域网
4. 输入`interface`命令，选择要配置的接口，如`interface fa0/1`
5. 使用命令`switchport mode access`命令配置交换机的一个物理端口为访问（access）模式，使其成为只能属于单一VLAN（虚拟局域网）的端口
6. 使用命令`switchport access vlan` +虚拟局域网号，如`switchport access vlan 2`，将一个访问模式的端口分配给一个特定的VLAN（虚拟局域网）
7. 使用`exit`命令退出这个接口配置的命令行，重复上述步骤

本机配置vlan的命令截图如下

<img src="E:/Markdown图片/image-20231010185550910.png" alt="image-20231010185550910" width=500 />

小结一下：就是PC1和PC3属于虚拟局域网vlan2，PC2和PC4属于虚拟局域网vlan3，也可以使用`show vlan`命令查看交换机各接口对应的vlan情况

<img src="E:/Markdown图片/image-20231010191324513.png" alt="image-20231010191324513" width=500 />

在PC2中 PING PC3和PC4的结果如图，发现PC2 PING PC3不可以ping通，但是可以ping通PC4，所以我们可以验证结论：只有在同一个虚拟局域网（vlan）中的设备之间才可以相互传递信息

<img src="E:/Markdown图片/image-20231010191007117.png" alt="image-20231010191007117" width=500 />

##### （4）多集线器多交换机混合网络

网络拓扑结构如图

<img src="E:/Markdown图片/image-20231010191839633.png" alt="image-20231010191839633" width=500 />



按第二部分【2、（2）】中的终端配置方法配置交换机1和交换机2

配置交换机1：

<img src="E:/Markdown图片/image-20231010192038309.png" alt="image-20231010192038309" width=500 />

<img src="E:/Markdown图片/image-20231010192057271.png" alt="image-20231010192057271" width=500 />

P.S.这里需要将多个交换机相互连接的端口模式设置为trunk（主干模式），以允许在交换机之间传递VLAN信息，这样连接的设备可以知道每个VLAN的存在和配置。

配置交换机2：

<img src="E:/Markdown图片/image-20231010192346205.png" alt="image-20231010192346205" width=500 />

设置主干模式

<img src="E:/Markdown图片/image-20231010192404247.png" alt="image-20231010192404247" width=500 />

使用show vlan命令查看交换机vlan情况：

<img src="E:/Markdown图片/image-20231010192605262.png" alt="image-20231010192605262" width=500 />

<img src="E:/Markdown图片/image-20231010192609840.png" alt="image-20231010192609840" width=500 />

下面的网络拓扑图标注了每个端口连接的主机及其所在的vlan

<img src="E:/Markdown图片/image-20231010191839633.png" alt="image-20231010191839633" width=500 />

进行跨交换机or跨集线器的ping——使用PC6分别 PING PC9和PC8，结果如图

<img src="E:/Markdown图片/image-20231010192833859.png" alt="image-20231010192833859" width=500 />

由此我们可以验证结论：**在多集线器、多交换机混合式网络中。即使划分跨越交换机的VLAN，也是在同一VLAN下的主机之间可以通信，不同VLAN的不行**

##### （5）使用模拟方式观察数据包在混合式以太网、虚拟局域网中的传递过程

**首先观察同一VLAN下的情况——使用PC1 PING PC8**，并只过滤出ICMP数据包，得到数据包输出过程如图

<img src="E:/Markdown图片/1d3d1bde74ec4d2e82ab404f1a40c9e.png" alt="1d3d1bde74ec4d2e82ab404f1a40c9e" width=500 />

<img src="E:/Markdown图片/83b2193344287551f2a3fd9f5f28844.png" alt="83b2193344287551f2a3fd9f5f28844" width=500 />

**使用PC1 PING PC3**：

<img src="E:/Markdown图片/1f670b127facfb770c83cb88a3ab534-1696938212195.png" alt="1f670b127facfb770c83cb88a3ab534" width=500 />

<img src="E:/Markdown图片/5974a99fe4de84ad0c4323fc3ac010d.png" alt="5974a99fe4de84ad0c4323fc3ac010d" width=500/>

都可以PING通

**随后观察不同VLAN下情况——PC1 ping PC9**，只过滤出ICMP数据包，发现情况如下图所示，PC1无法在自己本身的vlan中找到PC9的地址，导致数据包发送失败，下图所示的模拟界面中只有两个ICMP的数据包

<img src="E:/Markdown图片/image-20231011141723540.png" alt="image-20231011141723540" width=500 />

<img src="E:/Markdown图片/image-20231011141923084.png" alt="image-20231011141923084" width=500/>

**相关思考**：按理说集线器是一种非智能设备，不会阻止任何广播或单播流量，会将接收到的任何数据包发送到它的所有其他端口，所以应该PC1发出的数据包应该最远可以达到交换机switch1，在这里找不到其VLAN中的目标设备导致ping失败。**更详细的数据包模拟分析请见3、（2）部分**



##### （6）仿真环境提供的简化配置方式

可以直接使用**图形化界面**或者**CLI界面**来配置交换机的具体设置，不需要使用命令行

<img src="E:/Markdown图片/image-20231011142058388.png" alt="image-20231011142058388" width=500 />

可以在setting部分设置交换器的展示名称、主机名称并执行清空配置、保存配置等操作；在VLAN database中可以添加或删除VLAN，在INTERFACE标签下的各个具体接口中可以设置其对应的VLAN和模式（access或trunk）

### 3、实验拓展尝试

在跨交换机与集线器的连通性测试实验中，若不过滤ICMP数据包发现了**ARP协议**、**STP协议**、**CDP协议**与**DTP协议**，并且发现这些协议在主机之间通信非常重要

##### （1）五种协议介绍

**ARP协议**：一个**地址解析协议**，用于发现网络上设备的IP地址和MAC地址之间映射关系的协议。当一个设备需要向网络上的另一个设备发送数据包时，它需要知道目标设备的MAC地址。如果发送方知道目标IP地址，但不知道与之关联的MAC地址，它将使用ARP来发现这一信息。

举例：如果两个主机（主机A和主机B）正在通信，那么ARP协议将以如下步骤完成：

- **主机A尝试与主机B通信**：主机A有主机B的IP地址，但可能不知道其MAC地址。为了得知这一信息，主机A发送一个ARP请求，询问拥有主机B IP地址的设备的MAC地址是什么。
- **主机B响应ARP请求**：主机B接收到ARP请求，并响应，提供其MAC地址。
- **通信开始**：一旦主机A知道主机B的MAC地址，它就可以开始向主机B发送数据包。



**STP协议**：**生成树协议**，目的是防止在以太网网络中的逻辑环路（loop）。STP能够检测到网络中的环路，然后禁用一些网络路径来消除环路，但是仍然保留可能导致环路的路径，防止可能的广播风暴和其他与环路相关的问题。

在我们的实验环境中，只要涉及到交换机或桥接器，STP协议通常也会**在后台运行**。思科的交换机在默认配置下会运行STP，所以在模拟过程中会出现很多STP协议数据包，此外在多VLAN环境中，交换机需要**为每个VLAN或实例分别运行STP**。这将导致每个VLAN/实例都发送自己的BPDU消息，从而增加了网络上的STP消息数量。

> BPDU消息：桥接协议数据单元，是在STP协议中使用的数据包，交换机使用BPDU来选举网络中的根桥，通过交换BPDU，交换机可以确定其端口在生成树中的角色（例如，根端口、指定端口等）和状态（例如，阻塞或转发）



**CDP协议**：

思科专有的一种协议，用于在**直接相连**的网络设备之间发现信息（设备标识符、IP地址等），Cisco设备默认启用CDP。这是一个数据链路层协议，它允许在直接相连的网络设备之间交换信息，即使它们运行的是不同的网络层协议。

在我们的实验环境中，CDP也在背景中运行，并会周期性地在其接口上发送CDP通告，以便相邻的Cisco设备可以发现它们。在虚拟局域网中，CDP还可以传递VLAN和VTP（VLAN Trunking Protocol——主干接口）的信息。此部分可**以通过软件相关设置来禁用**



**DTP协议**：思科动态中继协议DTP，用于协商两台设备间链路上的中继过程以及中继封装802.1Q类型，模拟网络中的交换机被配置为多个VLAN，交换机可能会使用DTP来尝试与相邻的交换机协商VLAN截断的建立。

所以在我们的实验中，当数据包出现跨交换机传输的行为的时候则会出现DTP协议，用于多个交换机之间协商VLAN截断的建立。



**ICMP协议**

互联网控制消息协议，是一个核心的**网络层**协议，用于在IP网络上提供错误报告和诊断功能。它是`TCP/IP`协议族的一部分，经常被用于诊断网络连接问题。我们使用的ping命令测试网络连接的时候主机就会发送ICMP数据包。

ICMP数据包传输有一个**生存时间**，当一个主机发送数据包后，在这个时间以内没有接到返回的数据包，则认为网络不连通

##### （2）过滤出五种协议的跨交换机与集线器的连通性测试模拟分析

使用的例子依旧是PC1 PING PC9，图像见部分2、（5）

首先，PC1广播ARP数据包，整个线路中在vlan1中的的设备都会收到ARP数据包，这个过程其实是根据PC的IP地址找到MAC地址的过程，但是**只有同一vlan中的设备会受到这个数据包**

<img src="E:/Markdown图片/image-20231011093730263.png" alt="image-20231011093730263" width=500 />

> 注：有时候ARP数据包并不会出现，可能的原因是系统缓存问题，系统缓存好了每个设备的MAC地址，预先不需要使用ARP去查

随后将进入漫长的发送接收STP数据包的过程，自动检测网络环路，由于相关设置问题，这个过程持续时间比较久。具体情况如下图所示。

<img src="E:/Markdown图片/image-20231011094121573.png" alt="image-20231011094121573" width=500 />

随后PC1发送的ICMP数据包无法找到路径到达指定的目的主机（PC9），产生错误，此时两个交换机将会广播CDP数据包，询问各端口各VLAN的情况

<img src="E:/Markdown图片/image-20231011144312546.png" alt="image-20231011144312546" width=500/>

<img src="E:/Markdown图片/image-20231011144333955.png" alt="image-20231011144333955" width=500 />

其中如果涉及跨交换机的VLAN查询，将涉及DTP协议的使用，首先查看switch1的，如下图

<img src="E:/Markdown图片/image-20231011144402524.png" alt="image-20231011144402524" width=500 />

<img src="E:/Markdown图片/image-20231011144446289.png" alt="image-20231011144446289" width=500 />

随后查看switch2的，DTP数据包从switch2发送，一直发回到PC1，如下图

<img src="E:/Markdown图片/image-20231011155735025.png" alt="image-20231011155735025" width=500 />

随后将会一直重复CDP数据包分发和DTP数据包的分发，这可能意味着通信尚未成功建立或者数据包捕获过滤器设置有误

##### （3）禁用测试

可以在交换机中设置禁用STP/CDP协议，只要我们知晓这样做的后果

- 在禁用 STP 之前，需要确保网络拓扑中没有环路，以防止广播风暴和不可预测的网络行为。

- CDP 可以帮助网络管理员了解设备的邻居和网络拓扑，禁用它可能使网络故障排除和文档记录变得更加复杂。

使用如下命令在交换机中进行设置来完成禁用相关协议

**在特定vlan下禁用STP**

```bash
Switch> enable
Switch# configure terminal
Switch(config)# no spanning-tree vlan [vlan-id]
```

**在特定接口下禁用CDP**

```bash
Switch> enable
Switch# configure terminal
Switch(config)# interface Ethernet 0/1
Switch(config-if)# no cdp enable
```

**全局禁用CDP**

```bash
Switch> enable
Switch# configure terminal
Switch(config)# no cdp run
```

随后事件列表中将不显示CDP和STP协议，如下图，但是由于不同虚拟局域网中主机间通信尚未成功建立，DTP协议会一直循环执行。

<img src="E:/Markdown图片/image-20231011161819041.png" alt="image-20231011161819041" width=500 />